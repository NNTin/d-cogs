name: CI

on:
  push: # running in all branches
  pull_request:
    branches: [main, develop]

jobs:
  ruff-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run Ruff via action
        uses: astral-sh/ruff-action@v3
        with:
          # optional parameters:
          version: 'latest'
          args: 'check --output-format=github .'
          src: '.'

  action-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download and run actionlint
        run: |
          bash <(curl -s https://raw.githubusercontent.com/rhysd/actionlint/main/scripts/download-actionlint.bash)
          ./actionlint -color

  build-discord-fields:
    runs-on: ubuntu-latest
    needs: [ruff-check, action-check]
    if: always() && github.event_name == 'pull_request'
    outputs:
      discord_fields: ${{ steps.discord_fields.outputs.fields }}
    
    steps:
      - name: Build Discord Fields
        id: discord_fields
        run: |
          RUFF_STATUS="${{ needs.ruff-check.result }}"
          ACTION_STATUS="${{ needs.action-check.result }}"
          
          # Build JSON fields with readable formatting
          FIELDS=$(jq -n \
            --arg repo "${{ github.repository }}" \
            --arg branch "${{ github.ref_name }}" \
            --arg status_ruff "$RUFF_STATUS" \
            --arg status_action "$ACTION_STATUS" \
            --arg event "Pull Request" \
            --arg actor "${{ github.actor }}" \
            --arg commit "${{ github.sha }}" \
            --arg run_url "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            '[
              {"name": "Repository", "value": $repo, "inline": true},
              {"name": "Branch", "value": $branch, "inline": true},
              {"name": "Python Ruff Check", "value": ($status_ruff == "success" and "✅ Passed" or "❌ Failed"), "inline": true},
              {"name": "Actionlint Check", "value": ($status_action == "success" and "✅ Passed" or "❌ Failed"), "inline": true},
              {"name": "Event Type", "value": $event, "inline": true},
              {"name": "Triggered By", "value": ("@" + $actor), "inline": true},
              {"name": "Commit", "value": $commit, "inline": true},
              {"name": "Workflow Run", "value": ("[View Details](" + $run_url + ")"), "inline": false}
            ]')
          
          # Use delimiter to safely output the multiline JSON
          delimiter="$(openssl rand -hex 8)"
          echo "fields<<${delimiter}" >> $GITHUB_OUTPUT
          echo "$FIELDS" >> $GITHUB_OUTPUT
          echo "${delimiter}" >> $GITHUB_OUTPUT

  discord-notify:
    uses: nntin/d-flows/.github/workflows/discord-notify.yml@v0
    needs: [ruff-check, action-check, build-discord-fields]
    if: always() && github.event_name == 'pull_request'
    secrets:
      webhook_url: ${{ secrets.DISCORD_WEBHOOK_URL }}
    with:
      message_type: "embed"
      title: ${{ (needs['ruff-check'].result == 'success' && needs['action-check'].result == 'success') && '✅ d-cogs CI Passed' || '❌ d-cogs CI Failed' }}
      description: ${{ (needs['ruff-check'].result == 'success' && needs['action-check'].result == 'success') && 'd-cogs CI checks have passed successfully.' || 'The CI workflow encountered errors. Please check the workflow run for details.' }}
      color: ${{ (needs['ruff-check'].result == 'success' && needs['action-check'].result == 'success') && '3066993' || '15158332' }}
      fields: ${{ needs.build-discord-fields.outputs.discord_fields }}

  ci-summary:
    uses: nntin/d-flows/.github/workflows/step-summary.yml@v0
    needs: [ruff-check, action-check, build-discord-fields]
    if: always()
    with:
      title: "CI Summary"
      markdown: |
        ## CI Results
        
        **Python Ruff Check:** ${{ needs['ruff-check'].result == 'success' && '✅ Passed' || '❌ Failed' }}
        **Actionlint Check:** ${{ needs['action-check'].result == 'success' && '✅ Passed' || '❌ Failed' }}

        **Workflow Details:**
        - **Repository:** ${{ github.repository }}
        - **Branch:** ${{ github.ref_name }}
        - **Commit:** ${{ github.sha }}
        - **Event:** ${{ github.event_name }}
        - **Run ID:** ${{ github.run_id }}
        
        **Links:**
        - [View Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
      overwrite: true